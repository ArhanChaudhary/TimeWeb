{% extends "template.html" %}
{% load static %}

{% block css %}
#header {
  transition: all 1.2s cubic-bezier(.14,.34,.06,1.31);
}
#footer {
  transition: all 1.25s cubic-bezier(.25,.57,.51,.97);
}
#content {
  transition: all 1.25s cubic-bezier(.25,.57,.51,.97), border-width 0.75s cubic-bezier(.25,.57,.51,.97);
}
#header.animate {
  transform:translateY(-70px);
  height:80px;
}
#footer.animate {
  transform:translateY(-70px);
}
#content.animate {
  border-width:0;
  height:115vh;
  transform:translateY(-70px);
}
#assignmentscontainer {
  transition: all 1.2s cubic-bezier(.21,.66,.01,1.13);
}
#assignmentscontainer.animate {
  transform:translateY(max(calc(-100vh + 140px),calc(-100% - 20px)));
}

#imagenew {
  left:5px;
  position:absolute;
}
#imagenewcontainer {
  position:absolute;
  height:60px;
  width:70px;
}
#newassignmenttext {
  position:absolute;
  left:75px;
  top:0;
  color:white;
  font-size:20px;
  font-family:"Open Sans";
  display:block;
  max-width:calc(50% - 190px);

  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

#info {
  font-family:"Open Sans";
  font-size:17px;
  margin:10px 0 0 10px;
}
#hidebutton {
  position:relative;
  left:1px;
  bottom:0.65px;
  font-family:"Open Sans";
}
.assignmentcontainer {
  min-height:40px;
  min-width:720px;
  position:relative;
  overflow:visible !important;
}
.assignment {
  box-shadow: 0 0 4px rgba(52,52,52,0.5); 
  background:white;//rgba(233,68,46,0.5);
  margin:10px;
  padding:15px;
  border:2px solid gray;
  border-radius:5px;
  position:relative;
  width:calc(100% - 54px);
  min-height:0;
}
.assignment:focus, .button:focus {
  outline:0;
  border:2px solid rgb(0,95,204) !important;
  box-shadow: 0 0 4px rgba(0,95,204,0.5); 
}
.assignment.disablehover {
  display:block;
  min-height:65vh;
  transition:all .2s ease-in-out, opacity .1s ease-in-out, min-height 0s;
}
.assignment:not(.disablehover) {
  transition:all .2s ease-in-out, opacity .1s ease-in-out, min-height 0.1s ease-out;
}
.assignment:not(.disablehover):hover:focus {
  box-shadow: 0 0 7px rgba(0,95,204,0.7) !important; 
}
.assignment:not(.disablehover):hover {
  transform: scale(1.05) translateX(2%);
  width: calc(96.2% - 55px);
  border-color: rgba(0,0,0,0.7);
  box-shadow: 0 0 7px rgba(52,52,52,0.7); 
}
.assignment:not(.disablehover):hover .title span {
  opacity:0;
}
.assignment:not(.disablehover):hover .title:before {
  top:50%;
  transform:translateY(-50%);
  position:absolute;
  content:'Click to open';
}
.assignmentheader {
  display:flex;
  align-items:center;
  position:relative;
}
.title {
  float:left;
  min-width:calc(95px + 8vw);
  max-width:calc(95px + 8vw);
  font-size:min(16.76px,calc(11px + 0.4vw));
  font-family:"Open Sans";
  overflow-wrap:break-word;
}
.importance {
  position:absolute;
  font-size:0.7em;
  font-family:"Open Sans";
  margin-top:calc(-1em - 2px);
}
.daysleft {
  position:absolute;
  font-size:0.7em;
  font-family:"Open Sans";
  margin-top:-2px;
}
.arrowcontainer {
  float:left;
  margin-left:max(5px,calc(-5px + 2vw));
}
.status {
  float:left;
  font-size:min(16.76px,calc(11px + 0.4vw));
  font-family:"Open Sans";
  margin:0 70px 0 0;
}
.button {
  position:absolute;
  background: radial-gradient(circle, lightgray 40%, gray 100%);
  border:2px solid gray;
  border-radius:50%;
  top:0;
  bottom:0;
  margin:auto;
}
.button:hover, .button:focus {
  background: radial-gradient(circle, white 35%, gray 100%);
}
.button:active {
  background: radial-gradient(circle, white 55%, gray 100%);
}
.updatebutton {
  right:30px;
  height:30px;
  width:30px;
}
.updatebuttonimage {
  top:5px;
  left:5px;
  position:relative;
}
.deletebutton {
  right:-10px;
  height:35px;
  width:35px;
}
.deletebuttonimage {
  top:1px;
  position:relative;
}

.graphcontainer {
  position:relative;
  top:10px;
  display:none;
}
canvas {
  padding:0;
  border-radius:12px;
  height:clamp(200px,65vh,400px);
  width:calc(100% - 34px);
  min-height:200px;
  max-height:400px;
  margin:5px;
}
.fixed-graph {
  border:4px solid rgba(0,0,0,0.35);
  {% comment %} rgb(178,178,178) {% endcomment %}
  margin-left:13px;
  position:absolute;
}
.graph {
  margin-left:13px;
  position:relative;
  border:4px solid transparent;
}

.graphfooter {
  height:100px;
}
{% endblock %}

{% block js %}
<script>
// Doesn't allow the user to go back and load deleted assignments to avoid a 404
window.addEventListener('popstate', function() {
    history.pushState(null, null, document.URL);
}());
</script>

<script>
// Starting animation
$(window).load(function() {
  // Use $(window).load(function() { instead because $(function() { sometimes fires too early and lags the animation a bit
  $(".animate").removeClass("animate");
  setTimeout(() => {
    document.getElementById('content').style.transition = 'none';
  }, 1300); // 50ms extra delay
});
</script>

<script>
// Keybinds
$(document).keypress(function(event) {
  if (event.shiftKey && event.key == 'N') {
    window.location.replace("{% url 'new' %}");
  } else if (event.key === "Enter" && $(document.activeElement).prop("tagName") !== 'BUTTON') {
    document.activeElement.click();
  }
});
</script>

<script>
// Delete button
$(function() {
  if (document.getElementsByClassName("importance").length !== 1) {
    $(".importance:first").html("Most Important");
    $(".importance:last").html("Least Important");
  }
  $('.deletebutton').click(function() {
    if (confirm('Are you sure you want to delete this assignment? (Press Enter)')) {

        // Data sent to server pointing to which assignment to delete
        const val = $(this).val();
        const name = $(this).attr('name');
        let data = {
          'csrfmiddlewaretoken': '{{ csrf_token }}',
        }
        data[name] = val;

        const assignmentcontainer = $(this).parent().parent().parent();

        // If the data was successfully sent, delete the assignment
        const success = function() {
          
          $(assignmentcontainer).css({
            // CSS doesn't allow transitions without presetting the property
            // So, use JQuery to set it's property and animate
            "height":$(assignmentcontainer).height()+20+"px",

            "margin-bottom":"-10px",
            "min-height":"0px",
          });
          if (!assignmentcontainer.is(':nth-child(2)')) {
            $(assignmentcontainer).css("margin-top","-10px");
          }
          $(assignmentcontainer.children(":first-child")).css({
            "position":"absolute",
            "opacity":"0",
          })
          $(assignmentcontainer).animate({height:"10px"},200,function() {
            $(assignmentcontainer).remove();
            if (document.getElementsByClassName("importance").length === 1) {
              $(".importance:first").empty();
              $(".importance:last").empty();
            }
          });
        }
        // Use an ajax POST to avoid a page reload which will replay the starting animation
        $.ajax({
            type: "POST",
            data: data,
            success: success,
            error: function(jqXHR, exception) {
              if (jqXHR.status === 0) {
                  alert('Failed to connect');
              } else if (jqXHR.status == 404) {
                  alert('Requested page not found, try again');
              } else if (jqXHR.status == 500) {
                  alert('Internal server error. Please contact me if you see this')
              } else if (exception === 'parsererror') {
                  alert('Requested JSON parse failed');
              } else if (exception === 'timeout') {
                  alert('Timeout error');
              } else if (exception === 'abort') {
                  alert('Request aborted');
              } else {
                  alert('Uncaught Error, \n' + jqXHR.responseText + "\nPlease contact me if you see this");
              }
            }
        });
    } else {
      return false;
    }
  });
});
</script>

<script>
// Hide and show estimated completion time
$(function() {
  $("#hidebutton").click(function() {
    $(this.previousSibling).toggle();
    this.innerHTML = this.innerHTML === 'Hide' ? 'Show' : 'Hide';
  });
});
</script>

<script>
// Entire graph
$(function() {
  function PreventArrowScroll(event) {
    // arrow keys
    if ([37, 38, 39, 40].indexOf(event.keyCode) > -1) {
        event.preventDefault();
    }
  }

  function resize() {
    if (assignment.hasClass("disablehover") && assignment.is(":visible")) {
      width = fixed_graph.getBoundingClientRect().width;
      height = fixed_graph.getBoundingClientRect().height;
      graph.width = width * scale;
      graph.height = height * scale;
      fixed_graph.width = width * scale;
      fixed_graph.height = height * scale;
      wCon = (width-55)/x;
      hCon = (height-55)/y;
      drawfixed();
      draw();
    }
  }
  function pset(x2=NaN,y2=NaN) {
      try {
          var x1 = Math.floor(x - red_line_start_x);
          var y1 = y - red_line_start_y;
          if (len_nwd) {
              x1 -= Math.floor(x1/7) * len_nwd + mods[x1 % 7];
          }
          if (isNaN(x2)) {
              a = y1 * (1 - skew_ratio) / ((x1-1) * x1);
              b = (y1 - x1 * x1 * a) / x1;
          } else {
              x2 = (x2 - 50) / wCon - red_line_start_x;
              y2 = (height - y2 - 50) / hCon - red_line_start_y;
              if (x2 < 0) {
                  skew_ratio = skew_ratio_lim;
                  throw "definevars";
              }
              var floorx2 = Math.floor(x2);
              if (len_nwd) {
                  if (nwd.includes((assign_day_of_week + floorx2 + red_line_start_x) % 7)) {
                      x2 = floorx2;
                  }
                  x2 -= Math.floor(x2/7) * len_nwd + mods[floorx2 % 7];
              }
              if (x2 >= x1) {
                  a = y1/x1;
                  b = a * (1-x1);
                  skew_ratio = 2 - skew_ratio_lim;
              } else {
                  if (remainder_mode) {
                      y2 -= y_fremainder;
                  }
                  a = (x2 * y1 - x1 * y2) / ((x1-x2) * x1 * x2);
                  b = (y1 - x1 * x1 * a) / x1;
                  skew_ratio = (a + b) * x1 / y1;
                  if (skew_ratio > skew_ratio_lim) {
                      skew_ratio = skew_ratio_lim;
                  } else if (skew_ratio < 2 - skew_ratio_lim) {
                      skew_ratio = 2 - skew_ratio_lim;
                  } else if (0.975 < skew_ratio && skew_ratio < 1.025) {
                      if (!x1) {
                          throw "zerodivision1";
                      }
                      skew_ratio = 1;
                      a = 0;
                      b = y1/x1;
                  }
              }
          }
          if (!Number.isFinite(a)) {
              throw "zerodivision2";
          }
      } catch {
          a = 0;
          b = y1;
          if (x1) {
              return_y_cutoff = 0;
          } else {
              return_y_cutoff = -1;
          }
          return_0_cutoff = 1;
          cutoff_transition_value = 0;
          return;
      }
      if (a <= 0 || a * b > 0) {
          var funct_zero = 0;
      } else {
          var funct_zero = -b/a;
      }
      if (a >= 0) {
          var funct_y = x1;
      } else {
          var funct_y = ((Math.sqrt(b*b+4*a*y1)-b)/a/2).toFixed(10);
      }
      if (funct_round < min_work_time) {
          cutoff_transition_value = 0;
          if (a) {
              cutoff_to_use_round = ((min_work_time_funct_round-b)/a/2).toFixed(10)-1e-10;
              if (funct_zero < cutoff_to_use_round && cutoff_to_use_round < funct_y) {
                  for (var n of [Math.floor(cutoff_to_use_round),Math.floor(cutoff_to_use_round + 1)]) {
                      var output = funct(n,false);
                      if (output > y) {
                          output = y;
                      } else if (output < 0) {
                          output = 0;
                      }
                      if (n == Math.floor(cutoff_to_use_round)) {
                          var prev_output = output;
                      }
                  }
                  if (output - prev_output) {
                      cutoff_transition_value = min_work_time_funct_round - output + prev_output;
                  } else {
                      cutoff_transition_value = 0;
                  }
              } else {
                  cutoff_transition_value = 0;
              }
          }
      }
      if (ignore_ends_mwt) {
          var y_value_to_cutoff = y1;    
      } else if (funct_round < min_work_time && (!a && b < min_work_time_funct_round || a && (a > 0) == (funct_y < cutoff_to_use_round))) {
          var y_value_to_cutoff = y1 - min_work_time_funct_round / 2;
      } else {
          var y_value_to_cutoff = y1 - min_work_time_funct_round + funct_round / 2;
      }
      if (y_value_to_cutoff > 0 && y > red_line_start_y && (a || b)) {
          if (a) {
              return_y_cutoff = ((Math.sqrt(b*b+4*a*y_value_to_cutoff)-b)/a/2).toFixed(10)-1e-10;
          } else {
              return_y_cutoff = (y_value_to_cutoff/b).toFixed(10)-1e-10;
          }
      } else {
          return_y_cutoff = 0;
      }
      if (return_y_cutoff < 1000) {
          if (return_y_cutoff < 1) {
              var output = 0;
          } else {
              for (let n = Math.floor(return_y_cutoff);n>0;n--) {
                  var output = funct(n,false);
                  if (output <= y - min_work_time_funct_round) {
                      break;
                  }
                  return_y_cutoff--;
              }
          }
          if (ignore_ends_mwt) {
              var lower = [return_y_cutoff,y-red_line_start_y-output];

              var did_loop = false;
              for (var n = Math.ceil(return_y_cutoff);n<x1;n++) {
                  var pre_output = funct(n,false);
                  if (pre_output >= y) {
                      break;
                  }
                  did_loop = true;
                  var output = pre_output;
                  return_y_cutoff++;
              }
              if (did_loop) {
                  var upper = [return_y_cutoff,y-red_line_start_y-output];
                  return_y_cutoff = [upper,lower][+(min_work_time_funct_round * 2 - lower[1] > upper[1])][0];
              }
          }
      }
      if (ignore_ends_mwt) {
          var y_value_to_cutoff = 0;
      } else if (funct_round < min_work_time && (!a && b < min_work_time_funct_round || a && (a > 0) == (funct_zero < cutoff_to_use_round))) {
          var y_value_to_cutoff = min_work_time_funct_round / 2;
      } else {
          var y_value_to_cutoff = min_work_time_funct_round - funct_round / 2;
      }
      if (y_value_to_cutoff < y1 && y > red_line_start_y && (a || b)) {
          if (a) {
              return_0_cutoff = ((Math.sqrt(b*b+4*a*y_value_to_cutoff)-b)/a/2).toFixed(10)-1e-10;
          } else {
              return_0_cutoff = (y_value_to_cutoff/b).toFixed(10)-1e-10;
          }
      } else {
          return_0_cutoff = 1;
      }
      if (x1 - return_0_cutoff < 1000) {
          if (x1 - return_0_cutoff < 1) {
              var output = 0;
          } else {
              for (var n = Math.ceil(return_0_cutoff);n<x1;n++) {
                  var output = funct(n,false);
                  if (output >= min_work_time_funct_round + red_line_start_y) {
                      break;
                  }
                  return_0_cutoff++;
              }
          }
          if (ignore_ends_mwt) {
              var upper = [return_0_cutoff,output];

              var did_loop = false;
              for (var n=Math.floor(return_0_cutoff);n>0;n--) {
                  var pre_output = funct(n,false);
                  if (pre_output <= red_line_start_y) {
                      break;
                  }
                  did_loop = true;
                  var output = pre_output;
                  return_0_cutoff--;
              }
              if (did_loop) {
                  var lower = [return_0_cutoff,output];
                  return_0_cutoff = [lower,upper][+(min_work_time_funct_round * 2 - upper[1] > lower[1])][0];
              }
          }
      }
  }

  function funct(n,translate=true) {
      if (translate) {
          n -= red_line_start_x;
          if (len_nwd) {
              n -= Math.floor(n/7) * len_nwd + mods[n % 7];
          }
          if (n > return_y_cutoff) {
              return y;
          } else if (n < return_0_cutoff) {
              return red_line_start_y;
          }
      }
      if (funct_round < min_work_time && (!a && b < min_work_time_funct_round || a && (a > 0) == (n < cutoff_to_use_round))) {
          var output = min_work_time_funct_round * Math.round(n*(a*n+b)/min_work_time_funct_round);
          if (a < 0) {
              output += cutoff_transition_value;
          } else {
              output -= cutoff_transition_value;
          }
      } else {
          var output = funct_round * Math.round(n*(a*n+b)/funct_round)
      }
      if (remainder_mode && output) {
          output += y_fremainder;
      }
      return output + red_line_start_y;
  }

  function draw(x2=NaN,y2=NaN) {
      let screen = graph.getContext("2d");
      screen.scale(scale,scale);
      screen.clearRect(0, 0, width, height);
      pset(x2,y2);
      //console.trace()
      let radius = wCon/3; // calculates circle radius
      if (radius > 3) {
          radius = 3;
      } else if (radius < 2) {
          radius = 2;
      }
      let circle_x;
      let circle_y;
      let line_end = Math.floor(x+Math.ceil(1/wCon));
      screen.strokeStyle = "rgb(233,68,46)"; // red
      screen.lineWidth = radius;
      screen.beginPath();
      for (let point = red_line_start_x;point<line_end;point+=Math.ceil(1/wCon)) {
          circle_x = Math.round(point*wCon+50);
          if (circle_x > width-5) {
              circle_x = width-5;
          }
          circle_y = Math.round(height-funct(point)*hCon-50);
          screen.lineTo(circle_x,circle_y);
          screen.arc(circle_x,circle_y,radius,0,2 * Math.PI);
          screen.moveTo(circle_x,circle_y);
      }
      screen.stroke();
      screen.beginPath();
      radius *= 3/4;
      if (len_works + 1 < line_end) {
          len_end = len_works + 1;
      }
      screen.strokeStyle = "rgb(1,147,255)"; // blue
      screen.lineWidth = radius;
      for (let point = 0;point<line_end;point+=Math.ceil(1/wCon)) {
          circle_x = Math.round((point+dif_assign)*wCon+50);
          if (circle_x > width-5) {
              circle_x = width-5
          }
          circle_y = Math.round(height-works[point]*hCon-50);
          screen.lineTo(circle_x-(point==0)*radius/2,circle_y);
          screen.arc(circle_x,circle_y,radius,0,2 * Math.PI);
          screen.moveTo(circle_x,circle_y);
      }
      screen.stroke();
      screen.scale(1/scale,1/scale);
  }

  function mousemove(event) { 
      let x2 = event.pageX - $(fixed_graph).offset().left;
      let y2 = event.pageY - $(fixed_graph).offset().top;
      draw(x2,y2);
  }

  function drawfixed() {

      // bg gradient
      let screen = fixed_graph.getContext("2d");
      screen.scale(scale,scale);
      gradient = screen.createLinearGradient(0,0,0,height*4/3);
      gradient.addColorStop(0,"white");
      gradient.addColorStop(1,"lightgray");
      screen.fillStyle = gradient;
      //alert(2);
      screen.fillRect(0, 0, width, height*4/3);

      // x and y axis rectangles
      screen.fillStyle = "rgb(185,185,185)";
      screen.fillRect(40, 0, 10, height);
      screen.fillRect(0, height-50, width, 10);

      // x axis label
      screen.fillStyle = "black";
      screen.textAlign = "center";
      screen.font = '17.1875px Open Sans';
      screen.fillText("Days", (width-50)/2+50, height-5);

      // y axis label
      screen.rotate(Math.PI/2);
      if (unit == "Minute") {
          var text = 'Minutes of Work';
      } else {
          var text = unit + 's (' + format_minutes(ctime) + ') per ' + unit;
      }
      screen.fillText(text, (height-50)/2, -2);
      screen.rotate(-Math.PI/2);

      screen.font = '13.75px Open Sans';
      screen.textBaseline = "top";
      let x_axis_scale = Math.pow(10,Math.floor(Math.log10(x))) * Math.ceil(x.toString()[0]/Math.ceil((width-100)/100));
      if (x >= 10) {
          let small_x_axis_scale = x_axis_scale / 5;
          let label_index = screen.measureText(Math.floor(x)).width * 1.25 < small_x_axis_scale * wCon;
          let font_size = 13.75;
          for (let smaller_index = 1;smaller_index<=Math.floor(x/small_x_axis_scale);smaller_index++) {
              let displayed_number = smaller_index * small_x_axis_scale;
              if (smaller_index % 5) {
                  screen.fillStyle = "rgb(215,215,215)";
                  screen.fillRect(displayed_number*wCon+48.5,0,2,height-50);
                  screen.fillStyle = "rgb(80,80,80)";
              }
              if (label_index || !(smaller_index % 5)) {
                  if (!(smaller_index % 5)) {
                      screen.fillStyle = "black";
                      screen.font = font_size + 2.75 + 'px Open Sans';
                  }
                  let numberwidth = screen.measureText(displayed_number).width;
                  let number_x_pos = displayed_number*wCon+50;
                  if (number_x_pos + numberwidth/2 > width-1) {
                      number_x_pos = width-numberwidth/2-1;
                  }
                  screen.fillText(displayed_number,number_x_pos,height-39);
                  if (!(smaller_index % 5)) {
                      screen.font = font_size + 'px Open Sans';
                  }
              }
          }
      }
      screen.textBaseline = "alphabetic";
      let y_axis_scale = Math.pow(10,Math.floor(Math.log10(y))) * Math.ceil(y.toString()[0]/Math.ceil((height-100)/100));
      if (y >= 10) {
          let small_y_axis_scale = y_axis_scale / 5;
          let font_size = 16.90625 - Math.ceil(y - y % y_axis_scale).toString().length * 1.71875;
          if (font_size < 8.5) {
              font_size = 8.5;
          }
          screen.font = font_size + 'px Open Sans';

          let text_height = screen.measureText(0).width * 2;
          let label_index = text_height < small_y_axis_scale*hCon;
          screen.textAlign = "right";
          for (let smaller_index = 1;smaller_index<=Math.floor(y/small_y_axis_scale);smaller_index++) {
              let displayed_number = smaller_index * small_y_axis_scale;
              if (smaller_index % 5) {
                  screen.fillStyle = "rgb(215,215,215)";
                  screen.fillRect(50,height-51.5-displayed_number*hCon,width-50,2);
                  screen.fillStyle = "rgb(80,80,80)";
              } 
              if (label_index || !(smaller_index % 5)) {
                  if (!(smaller_index % 5)) {
                      screen.fillStyle = "black";
                      screen.font = font_size * 1.2 + 'px Open Sans';
                  }
                  let number_y_pos = height-displayed_number*hCon-52+text_height/2;
                  if (number_y_pos < 6 + text_height/2) {
                      number_y_pos = 6 + text_height/2;
                  }
                  if (38.5 - screen.measureText(displayed_number).width < 1) {
                      screen.textAlign = "left";
                      screen.fillText(displayed_number,1,number_y_pos);
                      screen.textAlign = "right";
                  } else {
                      screen.fillText(displayed_number,38.5,number_y_pos);
                  }
                  if (!(smaller_index % 5)) {
                      screen.font = font_size + 'px Open Sans';
                  }
              }                      
          }
      }
      screen.fillStyle = "rgb(205,205,205)";
      for (let bigger_index = Math.ceil(x - x % x_axis_scale);bigger_index>0;bigger_index-=x_axis_scale) {
          screen.fillRect(bigger_index*wCon+47.5,0,5,height-50);
      }
      for (let bigger_index = Math.ceil(y - y % y_axis_scale);bigger_index>0;bigger_index-=y_axis_scale) {
          if (bigger_index * 2 < y_axis_scale) {
            break;
          }
          screen.fillRect(50,height-bigger_index*hCon-52.5,width-50,5);
      }
  }
  function format_minutes(total_minutes) {
    var hour = Math.floor(total_minutes / 60);
    var minute = Math.ceil(total_minutes % 60);
    if (!hour) {
        if (total_minutes && total_minutes < 1) {
          return "<1m";
        }
        return minute + "m";
    } else if (!minute) {
      return hour + "h";
    } else {
      return hour + "h " + minute + "m";
    }
  }
  var funct_round,
      min_work_time,
      x,
      y,
      red_line_start_x,
      red_line_start_y,
      nwd,
      ignore_ends,
      assign_day_of_week,
      unit,
      ctime,
      dif_assign,
      skew_ratio,
      skew_ratio_lim,
      len_works,
      draw_point,
      remainder_mode,
      y_fremainder,
      ignore_ends_mwt,
      len_nwd,
      set_skew_ratio,
      mods,
      works,
      assignment
  $(".assignment").click(function(event) {
    if (!["A","IMG","BUTTON","CANVAS"].includes(event.target.tagName)) {
      assignment = $(this);
      const graphcontainer = assignment.children(":nth-child(2)");
      const not_first_click = assignment.data('not_first_click');
      if (graphcontainer.attr("style")) {
        assignment.removeClass("disablehover");
        graphcontainer.removeAttr("style");
        assignment.find(".fallingarrowanimation").get(0).beginElement();

        // If no graphs are open, allow auto scroll
        if (!document.getElementsByClassName("disablehover").length) {
          window.removeEventListener("keydown", PreventArrowScroll, false);
        }
      } else {
        // Prevents auto scroll if a graph is open
        if (!document.getElementsByClassName("disablehover").length) {
          window.addEventListener("keydown", PreventArrowScroll, false);
        }

        assignment.addClass("disablehover");
        graphcontainer.attr("style","display:block");
        assignment.find(".risingarrowanimation").get(0).beginElement();

        graph = this.querySelector('.graph');
        fixed_graph = this.querySelector('.fixed-graph');
        scale = window.devicePixelRatio;

        funct_round = 1;
        min_work_time = 2;
        x = 500000;
        y = 500000;
        red_line_start_x = 0;
        red_line_start_y = 0;
        nwd = [];
        ignore_ends = true;
        assign_day_of_week = 3;
        unit = "Minute";
        ctime = 2;
        dif_assign = 0;
        works = [0,1,2];
        skew_ratio = 1;


        mods;
        skew_ratio_lim = 10000;

        len_works = works.length;
        draw_point = false;
        remainder_mode = false;
        y_fremainder = (y - red_line_start_y) % funct_round;
        ignore_ends_mwt = ignore_ends && min_work_time;
        len_nwd = nwd.length;
        set_skew_ratio = false;
        if (min_work_time) {
            min_work_time_funct_round = Math.ceil(min_work_time/funct_round)*funct_round;
        } else {
            min_work_time_funct_round = funct_round;
        }
        resize();
        setTimeout(resize,250); // calling getBoundingClientRect() immediately returns the scaleY(1.02) height and width, add 50ms delay
        if (!not_first_click) {
          
          // Sets event handlers only on the assignment's first click
          $(window).resize(resize);
          let abort;
          let fired = false;
          let graphinterval;
          let whichkey;
          function ChangeSkewRatio() {
            if (whichkey) {
              skew_ratio -= 0.1;
            } else {
              skew_ratio += 0.1;
            }
            draw();
          }
          $(document).keydown(function(event) {
            if ($(fixed_graph).is(":visible")) {
              const rect = fixed_graph.getBoundingClientRect();
              if (rect.bottom - rect.height / 4 > 70 && rect.y + rect.height / 4 < document.getElementById("footer").getBoundingClientRect().y /* Originally window.innerHeight - (window.innerHeight - footer.y) */ && !fired) {
                fired = true;
                if (event.key === "ArrowUp" || event.key === "ArrowDown") {
                  whichkey = event.key === "ArrowDown";
                  ChangeSkewRatio()
                  abort = false;
                  setTimeout(function() {
                    if (!abort) {
                      clearInterval(graphinterval);
                      graphinterval = setInterval(ChangeSkewRatio,13); // Draws every frame
                    }
                  },500);
                }
              }
            }
          });
          $(document).keyup(function(event) {
            fired = false;
            if ((event.key === "ArrowDown") === whichkey) {
              abort = true;
              clearInterval(graphinterval);
            }
          });
        }

        // stop set skew ratio if canvas is clicked
        graph.onclick = () => graph.removeEventListener("mousemove",mousemove); 
        
        // enabled set skew ratio if button is pressed
        this.querySelector(".set-skew-ratio-button").onclick = function() { 
            graph.addEventListener('mousemove',mousemove); 
        }
      }
      assignment.data('not_first_click',true);
    }
  });
});
</script>

{% endblock %}


{% block body %}

<div class="headerfooter animate" id="header">
  <a href="{% url 'new' %}" title="(Shift + N)" id="newassignmentcontainer">
    <div id="imagenewcontainer">
      <img height="60" id="imagenew" src="{% static 'plus.png' %}" alt="new"></img>
    </div>
    <div id="newassignmenttextcontainer">
      <p id="newassignmenttext">New Assignment</p>
    </div>
  </a>
  <a href="{% url 'home' %}" id="logo">
    <img src="https://fontmeme.com/permalink/201230/276691b6653dba95c45110441239adff.png" alt="TimeWeb" border="0" id="logo">
  </a>
</div>

<div id="content" class="animate">
  <div id="assignmentscontainer" class="animate">
    <div id="info">Estimated total Completion time: <span>1h 24m</span><button id="hidebutton">Hide</button></div>
    {% for obj in objlist %}
      <div class="assignmentcontainer">
        <div class="assignment" tabindex="0">
          <div class="assignmentheader">
            <span class="title">
              <p class="importance"></p>
              <span>{{ obj.title }}</span>
              <p class="daysleft">1d</p>
            </span>
            <svg width="30px" height="20px" class="arrowcontainer">
              <polygon class="arrow" points="5,0 5,20 15,10">
                <animate class="risingarrowanimation" begin="indefinite" fill="freeze" attributeName="points" dur="100ms" to="20,5 0,5 10,15"/>
                <animate class="fallingarrowanimation" begin="indefinite" fill="freeze" attributeName="points" dur="100ms" to="5,0 5,20 15,10"/>
              </polygon>
            </svg>
            <p class="status">Nice Job! You are Finished with this Assignment for Today. Keep it up!</p>
            <a class="button updatebutton" href="{% url 'list' obj.pk%}">
              <img height="20" src="{% static 'edit.png' %}" alt="delete" class="updatebuttonimage" draggable="false"/>
            </a>
            <button name="{{ obj.pk }}" value="deleted" class="button deletebutton">
              <img height="22" src="{% static 'delete.png' %}" alt="edit" class="deletebuttonimage" draggable="false"/>
            </button>
          </div>
          <div class="graphcontainer">
            <canvas class="fixed-graph"></canvas>
            <canvas class="graph">Your browser does not support the canvas tag.</canvas>
            <button class="set-skew-ratio-button">Set skew ratio</button>
            <div class="graphfooter">
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<div class="headerfooter animate" id="footer"></div>

{% endblock %}